version: "3"

tasks:
  setup:
    summary: Sets up build environment
    cmds:
      - mise install
      - go mod download
      - mkdir -p {{.BIN_DIR}}
      - mkdir -p runtimes

  go:mod:tidy:
    summary: Runs go mod tidy
    internal: true
    cmds:
      - go mod tidy

  generate:bindings:
    summary: Generates code bindings
    deps:
      - task: go:mod:tidy
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    cmds:
      - go generate ./...

  test:unit:
    summary: Runs unit tests
    deps:
      - task: setup
    cmds:
      - go test -tags=dev_build ./...

  # Linting tasks
  lint:go:
    summary: Runs Go linters
    cmds:
      - golangci-lint run

  # Formatting tasks
  fmt:go:
    summary: Formats Go code
    cmds:
      - go fmt ./...
      - goimports -w .

  # Build helpers
  build:go:binary:
    summary: Builds a Go binary with specified parameters
    internal: true
    vars:
      BUILD_CMD: go build
      LDFLAGS: '{{.LDFLAGS | default "-s -w"}}'
      BUILD_FLAGS: '{{.BUILD_FLAGS | default "-trimpath -tags=netgo"}}'
      OUTPUT: "{{.OUTPUT}}"
      PACKAGE: "{{.PACKAGE}}"
    cmds:
      - '{{.BUILD_CMD}} -ldflags="{{.LDFLAGS}}" {{.BUILD_FLAGS}} -o {{.OUTPUT}} {{.PACKAGE}}'




